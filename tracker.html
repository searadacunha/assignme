<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mes Candidatures - ASSIGNME</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #0a0b10;
      color: #eaf2ff;
      min-height: 100vh;
    }

    .glass {
      backdrop-filter: blur(10px);
      background: rgba(16,18,27,.45);
      border: 1px solid rgba(149,210,230,.18);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }

    .status-draft {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .status-sent {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .status-viewed {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
    }

    .status-interview {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .status-offer {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-rejected {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .nav-brand {
      color: #ffffff !important;
    }

    .footer-brand {
      color: #ffffff !important;
    }

    .filter-btn.active {
      background: rgba(149, 210, 230, 0.3) !important;
      color: #95D2E6 !important;
      border: 1px solid rgba(149, 210, 230, 0.5);
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateX(400px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .animate-fade-in {
      animation: fade-in 0.3s ease;
    }
  </style>
  
  <link href="favicon.png" rel="icon" type="image/png">
</head>
<body>
  <!-- Header -->
  <header class="fixed top-0 inset-x-0 z-50">
    <nav class="glass mx-auto mt-4 w-[min(1100px,92%)] rounded-2xl px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-8">
        <a href="index.html" class="flex items-center gap-2">
          <img src="logo.png" alt="ASSIGNME" class="h-8 w-auto rounded-xl"/>
          <span class="text-base font-semibold tracking-tight uppercase nav-brand">ASSIGNME</span>
        </a>
        <div class="flex items-center gap-6 text-sm" style="color: #a9b9d6;">
          <a href="index.html" class="hover:text-white" style="text-decoration: none;">Accueil</a>
          <a href="index.html#about" class="hover:text-white" style="text-decoration: none;">Présentation</a>
          <a href="demo.html" class="hover:text-white" style="text-decoration: none;">Démo</a>
          <a href="tracker.html" class="hover:text-white font-semibold" style="color: #95D2E6; text-decoration: none;">Mes candidatures</a>
          <a href="info.html" class="hover:text-white" style="text-decoration: none;">À propos</a>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a href="index.html#contact" class="inline-flex px-4 py-2 rounded-xl bg-white text-black font-semibold hover:brightness-110" style="box-shadow: 0 0 80px rgba(149, 210, 230, 0.35); text-decoration: none;">Nous contacter</a>
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="pt-32 pb-20 px-4">
    <div class="max-w-6xl mx-auto">
      
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Mes Candidatures</h1>
        <p class="text-lg" style="color: #a9b9d6;">Suivez l'évolution de toutes vos candidatures générées par ASSIGNME</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="glass rounded-xl p-6">
          <div class="text-3xl font-bold text-blue-400" id="total-apps">0</div>
          <div class="text-sm mt-1" style="color: #a9b9d6;">Total candidatures</div>
        </div>
        
        <div class="glass rounded-xl p-6">
          <div class="text-3xl font-bold text-purple-400" id="total-sent">0</div>
          <div class="text-sm mt-1" style="color: #a9b9d6;">Envoyées</div>
        </div>
        
        <div class="glass rounded-xl p-6">
          <div class="text-3xl font-bold text-yellow-400" id="total-interviews">0</div>
          <div class="text-sm mt-1" style="color: #a9b9d6;">Entretiens</div>
        </div>
        
        <div class="glass rounded-xl p-6">
          <div class="text-3xl font-bold text-green-400" id="total-offers">0</div>
          <div class="text-sm mt-1" style="color: #a9b9d6;">Offres reçues</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="glass rounded-xl p-4 mb-6 flex gap-3 flex-wrap">
        <button onclick="filterByStatus('all')" class="px-4 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition filter-btn active" data-status="all">
          Toutes
        </button>
        <button onclick="filterByStatus('draft')" class="px-4 py-2 rounded-lg bg-gray-500/20 text-gray-400 hover:bg-gray-500/30 transition filter-btn" data-status="draft">
          Brouillons
        </button>
        <button onclick="filterByStatus('sent')" class="px-4 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition filter-btn" data-status="sent">
          Envoyées
        </button>
        <button onclick="filterByStatus('interview')" class="px-4 py-2 rounded-lg bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 transition filter-btn" data-status="interview">
          Entretiens
        </button>
        <button onclick="filterByStatus('offer')" class="px-4 py-2 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 transition filter-btn" data-status="offer">
          Offres
        </button>
      </div>

      <!-- Applications List -->
      <div id="applications-list" class="space-y-4">
        <!-- Dynamically populated -->
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="glass rounded-xl p-12 text-center" style="display: none;">
        <div class="text-6xl mb-4">Aucune candidature</div>
        <h3 class="text-2xl font-bold mb-3">Aucune candidature pour le moment</h3>
        <p class="mb-6" style="color: #a9b9d6;">Analysez votre CV et générez vos premières candidatures automatiques</p>
        <a href="demo.html" class="inline-flex px-6 py-3 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition" style="text-decoration: none;">
          Analyser mon CV
        </a>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="pt-12 pb-16">
    <div class="mx-auto w-[min(1100px,92%)] flex items-center justify-center">
      <div class="flex items-center gap-2">
        <img src="logo.png" alt="ASSIGNME" class="h-8 w-auto rounded-xl"/>
        <span class="text-base font-semibold footer-brand">ASSIGNME</span>
        <span class="mx-2" style="color: #a9b9d6;">2025 ASSIGNME. Tous droits réservés | Une innovation DeepTech française</span>
      </div>
    </div>
  </footer>

  <script>
    let applications = JSON.parse(localStorage.getItem('assignme_applications') || '[]');
    let currentFilter = 'all';

    document.addEventListener('DOMContentLoaded', () => {
      renderApplications();
      updateStats();
    });

    function renderApplications() {
      const container = document.getElementById('applications-list');
      const emptyState = document.getElementById('empty-state');
      
      const filtered = currentFilter === 'all' 
        ? applications 
        : applications.filter(app => app.status === currentFilter);

      if (filtered.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      container.style.display = 'block';
      emptyState.style.display = 'none';

      container.innerHTML = filtered.map((app, index) => `
        <div class="glass rounded-xl p-6 application-card" data-status="${app.status}">
          <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
              <h3 class="text-xl font-bold mb-2">${app.position}</h3>
              <p style="color: #a9b9d6;" class="mb-1">${app.company}</p>
              <p style="color: #a9b9d6;" class="text-sm mb-3">${app.location || 'Non spécifié'}</p>
              <div class="flex items-center gap-3 text-sm" style="color: #a9b9d6;">
                <span>Générée le ${new Date(app.generated_at).toLocaleDateString('fr-FR')}</span>
                ${app.sent_at ? `<span>• Envoyée le ${new Date(app.sent_at).toLocaleDateString('fr-FR')}</span>` : ''}
              </div>
            </div>
            
            <div class="flex flex-col gap-2 items-end">
              ${getStatusBadge(app.status)}
              <select 
                class="px-3 py-2 rounded-lg text-sm font-semibold cursor-pointer"
                style="background: rgba(16,18,27,.8); border: 1px solid rgba(149,210,230,.18); color: #eaf2ff;"
                onchange="updateStatus('${app.job_id}', this.value)"
              >
                <option value="draft" ${app.status === 'draft' ? 'selected' : ''}>Brouillon</option>
                <option value="sent" ${app.status === 'sent' ? 'selected' : ''}>Envoyée</option>
                <option value="viewed" ${app.status === 'viewed' ? 'selected' : ''}>Vue</option>
                <option value="interview" ${app.status === 'interview' ? 'selected' : ''}>Entretien</option>
                <option value="offer" ${app.status === 'offer' ? 'selected' : ''}>Offre</option>
                <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Refusée</option>
              </select>
            </div>
          </div>

          <!-- Cover Letter Preview -->
          <details class="mb-4">
            <summary class="cursor-pointer font-semibold py-2 px-4 rounded-lg hover:bg-white/5 transition" style="color: #95D2E6;">
              Lettre de motivation générée
            </summary>
            <div class="mt-3 p-4 rounded-lg" style="background: rgba(16,18,27,.6); border: 1px solid rgba(149,210,230,.18);">
              <p class="whitespace-pre-line text-sm leading-relaxed" style="color: #e8f4ff;">
${app.cover_letter || 'Lettre non disponible'}
              </p>
            </div>
          </details>

          <!-- Actions -->
          <div class="flex gap-3 flex-wrap">
            ${app.application_url && app.application_url !== '#' ? `
              <a href="${app.application_url}" target="_blank" 
                 class="px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition text-sm" style="text-decoration: none;">
                Voir l'offre
              </a>
            ` : ''}
            
            <button onclick="copyToClipboard('${app.job_id}', 'cover_letter')" 
                    class="px-4 py-2 rounded-lg font-semibold hover:bg-white/10 transition text-sm"
                    style="background: rgba(149,210,230,.1); border: 1px solid rgba(149,210,230,.3); color: #95D2E6;">
              Copier la lettre
            </button>
            
            <button onclick="downloadApplication('${app.job_id}')" 
                    class="px-4 py-2 rounded-lg font-semibold hover:bg-white/10 transition text-sm"
                    style="background: rgba(149,210,230,.1); border: 1px solid rgba(149,210,230,.3); color: #95D2E6;">
              Télécharger
            </button>
            
            <button onclick="deleteApplication('${app.job_id}')" 
                    class="px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition text-sm"
                    style="background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.3); color: #ef4444;">
              Supprimer
            </button>
          </div>
        </div>
      `).join('');
    }

    function getStatusBadge(status) {
      const badges = {
        'draft': '<span class="status-badge status-draft">Brouillon</span>',
        'sent': '<span class="status-badge status-sent">Envoyée</span>',
        'viewed': '<span class="status-badge status-viewed">Vue</span>',
        'interview': '<span class="status-badge status-interview">Entretien</span>',
        'offer': '<span class="status-badge status-offer">Offre reçue</span>',
        'rejected': '<span class="status-badge status-rejected">Refusée</span>'
      };
      return badges[status] || badges['draft'];
    }

    function updateStats() {
      const total = applications.length;
      const sent = applications.filter(a => ['sent', 'viewed', 'interview', 'offer'].includes(a.status)).length;
      const interviews = applications.filter(a => a.status === 'interview' || a.status === 'offer').length;
      const offers = applications.filter(a => a.status === 'offer').length;

      document.getElementById('total-apps').textContent = total;
      document.getElementById('total-sent').textContent = sent;
      document.getElementById('total-interviews').textContent = interviews;
      document.getElementById('total-offers').textContent = offers;
    }

    function filterByStatus(status) {
      currentFilter = status;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) {
          btn.classList.add('active');
        }
      });
      
      renderApplications();
    }

    function updateStatus(jobId, newStatus) {
      const app = applications.find(a => a.job_id === jobId);
      if (app) {
        app.status = newStatus;
        app.last_updated = new Date().toISOString();
        
        if (newStatus === 'sent' && !app.sent_at) {
          app.sent_at = new Date().toISOString();
        }
        
        localStorage.setItem('assignme_applications', JSON.stringify(applications));
        
        sendFeedback(jobId, newStatus, app);
        
        renderApplications();
        updateStats();
        
        showNotification(`Statut mis à jour : ${getStatusText(newStatus)}`);
      }
    }

    function getStatusText(status) {
      const texts = {
        'draft': 'Brouillon',
        'sent': 'Envoyée',
        'viewed': 'Vue',
        'interview': 'Entretien',
        'offer': 'Offre reçue',
        'rejected': 'Refusée'
      };
      return texts[status] || status;
    }

    async function sendFeedback(jobId, status, app) {
      try {
        await fetch('/.netlify/functions/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            candidateId: localStorage.getItem('candidate_id') || 'anonymous',
            jobId: jobId,
            feedbackType: status,
            data: {
              position: app.position,
              company: app.company,
              timestamp: new Date().toISOString()
            }
          })
        });
      } catch (error) {
        console.log('Feedback non envoyé:', error);
      }
    }

    function copyToClipboard(jobId, type) {
      const app = applications.find(a => a.job_id === jobId);
      if (app && app.cover_letter) {
        navigator.clipboard.writeText(app.cover_letter).then(() => {
          showNotification('Lettre copiée dans le presse-papiers');
        });
      }
    }

    function downloadApplication(jobId) {
      const app = applications.find(a => a.job_id === jobId);
      if (!app) return;
      
      const content = `
CANDIDATURE GÉNÉRÉE PAR ASSIGNME
================================

POSTE : ${app.position}
ENTREPRISE : ${app.company}
DATE : ${new Date(app.generated_at).toLocaleDateString('fr-FR')}

LETTRE DE MOTIVATION :
----------------------
${app.cover_letter}

CV ADAPTÉ :
-----------
${JSON.stringify(app.adapted_cv, null, 2)}
      `;
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `assignme_${app.company.replace(/\s+/g, '_')}_${Date.now()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification('Candidature téléchargée');
    }

    function deleteApplication(jobId) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer cette candidature ?')) {
        return;
      }
      
      applications = applications.filter(a => a.job_id !== jobId);
      localStorage.setItem('assignme_applications', JSON.stringify(applications));
      
      renderApplications();
      updateStats();
      
      showNotification('Candidature supprimée');
    }

    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'fixed top-24 right-4 glass rounded-xl p-4 z-50 animate-fade-in';
      notif.style.minWidth = '300px';
      notif.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="text-lg">INFO</div>
          <div class="flex-1 font-semibold">${message}</div>
        </div>
      `;
      
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transform = 'translateX(400px)';
        notif.style.transition = 'all 0.3s ease';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
