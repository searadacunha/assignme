<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASSIGNME - Démo connectée France Travail</title>
  
  <!-- React et Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="favicon.png" rel="icon" type="image/png">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Space Grotesk', 'ui-sans-serif', 'system-ui'] },
          colors: {
            base: '#0a0b10',
            ink: '#eaf2ff',
            muted: '#a9b9d6',
            neon: '#95D2E6'
          },
          boxShadow: { glow: '0 0 80px rgba(149, 210, 230, 0.35)' }
        }
      }
    }
  </script>
  
  <style>
    html, body { background:#0a0b10; color:#eaf2ff; }
    .glass { backdrop-filter: blur(10px); background: rgba(16,18,27,.45); border: 1px solid rgba(149,210,230,.18); }
    .hero-gradient { background-image: radial-gradient(1200px 600px at 60% -10%, rgba(149,210,230,.18), rgba(149,210,230,.10) 35%, rgba(10,11,16,1) 65%); }
    .nav-brand { color:#ffffff !important; }
    .footer-brand { color:#ffffff !important; }
    .chip { background: linear-gradient(135deg, rgba(149,210,230,.18), rgba(207,230,228,.10)); border: 1px solid rgba(149,210,230,.25); }
  </style>
</head>
<body class="font-sans antialiased selection:bg-accent/30">
  
  <!-- Header -->
  <header class="fixed top-0 inset-x-0 z-50">
    <nav class="glass mx-auto mt-4 w-[min(1100px,92%)] rounded-2xl px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-8">
        <a href="index.html" class="flex items-center gap-2">
          <img src="logo.png" alt="ASSIGNME" class="h-8 w-auto rounded-xl"/>
          <span class="text-base font-semibold tracking-tight uppercase nav-brand">ASSIGNME</span>
        </a>
        <div class="hidden md:flex items-center gap-6 text-sm text-muted">
          <a href="index.html" class="hover:text-ink">Accueil</a>
          <a href="index.html#solution" class="hover:text-ink">Solution</a>
          <a href="demo.html" class="hover:text-ink text-neon font-semibold">Démo</a>
          <a href="info.html" class="hover:text-ink">Plateforme</a>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a href="mailto:contact@assignme.fr" class="inline-flex px-4 py-2 rounded-xl bg-ink text-black font-semibold shadow-glow hover:brightness-110">Contact</a>
      </div>
    </nav>
  </header>

  <div id="root"></div>

  <footer class="pt-12 pb-16">
    <div class="mx-auto w-[min(1100px,92%)] flex items-center justify-center">
      <div class="flex items-center gap-2">
        <img src="logo.png" alt="ASSIGNME" class="h-8 w-auto rounded-xl"/>
        <span class="text-base font-semibold footer-brand">ASSIGNME</span>
        <span class="text-muted mx-2">© 2025 ASSIGNME. Tous droits réservés | Une innovation DeepTech française</span>
      </div>
    </div>
  </footer>

  <script type="text/babel">
    const { useState, useCallback, useEffect } = React;
    
    const AssignmeAnalyzer = () => {
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [analysisComplete, setAnalysisComplete] = useState(false);
      const [candidateProfile, setCandidateProfile] = useState(null);
      const [recommendations, setRecommendations] = useState([]);
      const [error, setError] = useState('');
      const [pdfReady, setPdfReady] = useState(false);
      const [fileName, setFileName] = useState('');
      const [progress, setProgress] = useState(0);
      const [currentStep, setCurrentStep] = useState('');

      useEffect(() => {
        if (window.pdfjsLib) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          setPdfReady(true);
        }
      }, []);

      const updateProgress = (step, progressValue) => {
        setCurrentStep(step);
        setProgress(progressValue);
      };

      const extractTextFromPDF = async (file) => {
        if (!pdfReady) throw new Error('PDF.js non initialisé');
        updateProgress("Lecture du fichier PDF...", 10);
        
        try {
          const arrayBuffer = await file.arrayBuffer();
          updateProgress("Analyse de la structure PDF...", 20);
          
          const pdf = await window.pdfjsLib.getDocument(arrayBuffer).promise;
          updateProgress(`PDF ouvert: ${pdf.numPages} page(s) détectée(s)`, 30);
          
          let fullText = '';
          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            updateProgress(`Extraction page ${pageNum}/${pdf.numPages}...`, 30 + (pageNum / pdf.numPages) * 30);
            const page = await pdf.getPage(pageNum);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n\n';
          }
          
          if (fullText.trim().length === 0) throw new Error('PDF vide ou texte non extractible');
          updateProgress(`Extraction terminée: ${fullText.length} caractères extraits`, 60);
          return fullText;
        } catch (error) {
          throw new Error(`Impossible de lire le PDF: ${error.message}`);
        }
      };

      const extractTextFromFile = async (file) => {
        const fileType = file.type;
        updateProgress(`Analyse du fichier: ${file.name}`, 5);
        
        if (fileType === 'application/pdf') return await extractTextFromPDF(file);
        if (fileType === 'text/plain') {
          updateProgress("Lecture du fichier texte...", 30);
          const text = await file.text();
          updateProgress("Fichier texte lu avec succès", 60);
          return text;
        }
        
        throw new Error(`Format non pris en charge: ${fileType}. Utilisez PDF ou TXT.`);
      };

      const analyzeWithNetlifyFunction = async (cvText) => {
        updateProgress("Connexion à France Travail...", 70);
        
        try {
          const response = await fetch('/.netlify/functions/analyze-cv', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cvText })
          });
          
          updateProgress(`Analyse terminée`, 80);
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`Erreur ${response.status}: ${errorData.error || 'Erreur inconnue'}`);
          }
          
          const result = await response.json();
          updateProgress("Matching terminé", 100);
          return result;
        } catch (error) {
          throw error;
        }
      };

      const handleFileSelect = useCallback(async (file) => {
        if (!file) return;

        const maxSize = 10 * 1024 * 1024;
        const allowedTypes = ['application/pdf', 'text/plain'];
        
        if (file.size > maxSize) {
          setError('Le fichier est trop volumineux (max 10MB)');
          return;
        }
        
        if (!allowedTypes.includes(file.type)) {
          setError('Format non supporté. Utilisez PDF ou TXT');
          return;
        }

        try {
          setFileName(file.name);
          setIsAnalyzing(true);
          setError('');
          setRecommendations([]);
          setAnalysisComplete(false);
          setProgress(0);

          const cvText = await extractTextFromFile(file);
          if (cvText.length < 100) throw new Error('Le contenu du CV semble trop court ou vide');
          
          const analysis = await analyzeWithNetlifyFunction(cvText);
          
          setCandidateProfile({
            ...analysis.candidate_analysis,
            ai_metadata: analysis.ai_metadata
          });
          
          setRecommendations(analysis.recommendations || []);
          setAnalysisComplete(true);
          
        } catch (error) {
          console.error("Erreur:", error);
          setError(error.message);
          setProgress(0);
        }
        
        setIsAnalyzing(false);
      }, [pdfReady]);

      const resetAnalysis = () => {
        setAnalysisComplete(false);
        setCandidateProfile(null);
        setRecommendations([]);
        setError('');
        setFileName('');
        setProgress(0);
        setCurrentStep('');
      };

      const triggerFileInput = () => {
        if (isAnalyzing || !pdfReady) return;
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf,.txt';
        input.onchange = (e) => handleFileSelect(e.target.files[0]);
        input.click();
      };

      return (
        <div className="min-h-screen pt-36 pb-24 hero-gradient">
          <div className="max-w-6xl mx-auto px-6">
            {!analysisComplete ? (
              <div>
                <div className="text-center mb-12">
                  <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full chip text-xs font-medium mb-6">
                    <span className="w-2 h-2 bg-neon rounded-full animate-pulse"></span>
                    Connecté à France Travail
                  </div>
                  
                  <h1 className="text-[29.4px] md:text-[42px] leading-[99%] font-normal text-ink mb-6">
                    Testez le <span className="text-neon">matching intelligent</span>
                  </h1>
                  
                  <p className="text-lg text-muted max-w-2xl mx-auto mb-8">
                    Déposez un CV et découvrez instantanément les opportunités adaptées issues de France Travail.
                  </p>
                </div>

                {error && (
                  <div className="mb-8 glass rounded-xl p-6 max-w-2xl mx-auto border-red-500/50">
                    <strong className="text-red-400">Erreur :</strong> <span className="text-red-300">{error}</span>
                  </div>
                )}

                {isAnalyzing && (
                  <div className="mb-8 glass rounded-xl p-6 max-w-4xl mx-auto">
                    <div className="mb-4">
                      <div className="w-full h-2 bg-muted/20 rounded-full overflow-hidden">
                        <div className="h-full bg-neon rounded-full transition-all duration-300" style={{width: `${progress}%`}}></div>
                      </div>
                      <p className="text-sm text-neon mt-2">{currentStep}</p>
                    </div>
                  </div>
                )}

                <div className="max-w-4xl mx-auto mb-16">
                  <div
                    className={`glass rounded-3xl p-16 text-center cursor-pointer transition-all duration-300 ${
                      isAnalyzing || !pdfReady ? 'opacity-50 cursor-not-allowed' : 'hover:border-neon/50'
                    }`}
                    onClick={triggerFileInput}
                  >
                    {isAnalyzing ? (
                      <div className="space-y-6">
                        <div className="animate-spin rounded-full h-16 w-16 border-4 border-neon/20 border-t-neon mx-auto"></div>
                        <div>
                          <p className="text-white font-bold text-2xl mb-2">Analyse en cours...</p>
                          <p className="text-muted">{currentStep}</p>
                          {fileName && <p className="text-neon text-sm mt-2">{fileName}</p>}
                          <div className="mt-4 text-neon text-sm">{progress}%</div>
                        </div>
                      </div>
                    ) : (
                      <div className="space-y-6">
                        <div className="text-7xl">📄</div>
                        <div>
                          <p className="text-white text-2xl font-semibold mb-4">
                            Déposez votre CV ici
                          </p>
                          <p className="text-muted mb-6">
                            PDF ou TXT • Max 10MB
                          </p>
                          <div className="inline-block bg-neon text-black px-6 py-3 rounded-xl font-semibold hover:brightness-110 transition">
                            Parcourir
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                <div className="grid md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                  <div className="glass rounded-xl p-6 text-center">
                    <h3 className="text-neon font-semibold mb-2">1. Analyse</h3>
                    <p className="text-sm text-muted">Extraction des compétences par IA</p>
                  </div>
                  <div className="glass rounded-xl p-6 text-center">
                    <h3 className="text-neon font-semibold mb-2">2. Matching</h3>
                    <p className="text-sm text-muted">Recherche sur France Travail</p>
                  </div>
                  <div className="glass rounded-xl p-6 text-center">
                    <h3 className="text-neon font-semibold mb-2">3. Résultats</h3>
                    <p className="text-sm text-muted">Offres adaptées avec score</p>
                  </div>
                </div>
              </div>
            ) : (
              <div>
                <div className="glass rounded-2xl p-8 mb-8">
                  <div className="flex justify-between items-start mb-6">
                    <div className="flex-1">
                      <h2 className="text-2xl font-bold text-ink mb-4">
                        Profil analysé : {candidateProfile.name || 'Candidat'}
                      </h2>
                      
                      <div className="grid md:grid-cols-2 gap-4 mb-6">
                        <div className="glass rounded-lg p-4">
                          <p className="text-sm text-muted mb-1">Localisation</p>
                          <p className="text-ink font-semibold">{candidateProfile.location || 'Non spécifiée'}</p>
                        </div>
                        <div className="glass rounded-lg p-4">
                          <p className="text-sm text-muted mb-1">Expérience</p>
                          <p className="text-ink font-semibold">{candidateProfile.total_experience_years || 0} ans</p>
                        </div>
                      </div>

                      {candidateProfile.technical_skills?.length > 0 && (
                        <div>
                          <p className="text-sm text-muted mb-2">Compétences identifiées</p>
                          <div className="flex flex-wrap gap-2">
                            {candidateProfile.technical_skills.map((skill, i) => (
                              <span key={i} className="px-3 py-1 bg-neon/20 text-neon text-sm rounded-full border border-neon/30">
                                {skill}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <button onClick={resetAnalysis} className="px-4 py-2 glass rounded-xl text-muted hover:text-ink hover:border-neon/50 transition">
                      Nouveau test
                    </button>
                  </div>
                </div>

                <h3 className="text-2xl font-bold text-ink mb-6">
                  {recommendations.length} opportunité(s) France Travail
                </h3>

                <div className="space-y-4">
                  {recommendations.map((job, index) => (
                    <div key={index} className="glass rounded-xl p-6">
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex-1">
                          <h4 className="text-xl font-bold text-ink mb-2">{job.job_title}</h4>
                          <div className="flex items-center gap-3 text-sm text-muted mb-3">
                            <span>{job.company}</span>
                            <span>•</span>
                            <span>{job.location}</span>
                            <span>•</span>
                            <span>{job.contract_type}</span>
                          </div>
                        </div>
                        {job.match_score && (
                          <div className="flex items-center justify-center w-12 h-12 rounded-full bg-neon text-black font-bold">
                            {job.match_score}%
                          </div>
                        )}
                      </div>
                      
                      <div className="glass rounded-lg p-4 mb-4 border border-neon/20">
                        <p className="text-sm text-muted">{job.match_justification}</p>
                      </div>
                      
                      {job.is_real_offer && job.france_travail_url && (
                        <a href={job.france_travail_url} target="_blank" rel="noopener noreferrer" className="inline-flex px-4 py-2 rounded-xl bg-neon text-black font-semibold hover:brightness-110 transition">
                          Voir sur France Travail
                        </a>
                      )}
                    </div>
                  ))}
                </div>

                <div className="mt-12 glass rounded-2xl p-8 text-center">
                  <p className="text-muted mb-6">
                    Cette démonstration illustre le moteur de matching ASSIGNME connecté à l'API France Travail.
                  </p>
                  <a href="mailto:contact@assignme.fr?subject=Demande démo ASSIGNME" className="inline-flex px-6 py-3 rounded-xl bg-ink text-black font-semibold shadow-glow hover:brightness-110">
                    Planifier une démo
                  </a>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(React.createElement(AssignmeAnalyzer), document.getElementById('root'));
  </script>
</body>
</html>
